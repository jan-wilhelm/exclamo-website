!function(e){"use strict";function o(){}function t(o){var t=o||"";return(t=(t=(t=t.replace(/<select[^>]*>/gi,"").replace("</select>","")).replace(/<\/optgroup>/gi,"")).replace(/<optgroup[^>]*>/gi,function(e){var o=/label="(.[^"]*)"(\s|>)/.exec(e),t=/data\-group\-id="(.[^"]*)"(\s|>)/.exec(e);return'<li class="dropdown-group" data-group-id="'+(t?t[1]:"")+'">'+(o?o[1]:"")+"</li>"})).replace(/<option(.*?)<\/option>/gi,function(o){var t=e(o).val(),n=/>(.*)<\//.exec(o),i=o.indexOf("selected")>-1,a=o.indexOf("disabled")>-1,l="";return o.replace(/data-(\w+)="?(.[^"]+)"?/g,function(e){l+=e+" "}),"<li "+(a?" disabled":' tabindex="0"')+' data-value="'+(t||"")+'" class="dropdown-option '+(i?"dropdown-chose":"")+'" '+l+">"+(n?n[1]:"")+"</li>"})}function n(o){var t={},n="",i=[],a=0,l=this.config.extendProps;return!(!o||!o.length)&&(e.each(o,function(o,n){var d=n.groupId,s=n.disabled?" disabled":"",r=n.selected&&!s?" selected":"",c="";e.each(l,function(e,o){n[o]&&(c+="data-"+o+'="'+n[o]+'" ')});var p="<option"+s+r+' value="'+n.id+'" '+c+">"+n.name+"</option>";r&&(i.push('<span class="dropdown-selected">'+n.name+'<i class="del" data-id="'+n.id+'"></i></span>'),a++),d?t[n.groupId]?t[n.groupId]+=p:t[n.groupId]=n.groupName+"&janking&"+p:t[o]=p}),e.each(t,function(e,o){var t=o.split("&janking&");if(2===t.length){var i=t[0],a=t[1];n+='<optgroup label="'+i+'" data-group-id="'+e+'">'+a+"</optgroup>"}else n+=o}),[n,i,a])}function i(o,t){this.$el=e(t),this.$select=this.$el.find("select"),this.placeholder=this.$select.attr("placeholder"),this.config=o,this.name=[],this.isSingleSelect=!this.$select.prop("multiple"),this.selectAmount=0,this.maxItemAlertTimer=null,this.isLabelMode="label"===this.config.multipleMode,this.init()}var a=function(){var e=navigator.userAgent.toLowerCase();if(-1!==e.indexOf("safari"))return!(e.indexOf("chrome")>-1)}(),l={readonly:!1,limitCount:1/0,input:'<input type="text" maxLength="20" placeholder="搜索关键词或ID">',data:[],searchable:!0,searchNoData:'<li style="color:#ddd">No option found</li>',init:o,choice:o,extendProps:[]},d={up:38,down:40,enter:13},s="click.iui-dropdown",r="focus.iui-dropdown",c="keydown.iui-dropdown",p="keyup.iui-dropdown",u={show:function(o){o.stopPropagation();e(document).trigger("click.dropdown"),this.$el.addClass("active")},search:function(e,o,t){var n,i,a,l=null,d=0;t||(t={});var s=function(){d=!1===t.leading?0:(new Date).getTime(),l=null,a=e.apply(n,i),l||(n=i=null)};return function(){var r=(new Date).getTime();d||!1!==t.leading||(d=r);var c=o-(r-d);return n=this,i=arguments,c<=0||c>o?(clearTimeout(l),l=null,d=r,a=e.apply(n,i),l||(n=i=null)):l||!1===t.trailing||(l=setTimeout(s,c)),a}}(function(o){var i=this.config,a=this.$el,l=e(o.target).val(),d=this.config.data,s=[];o.keyCode>36&&o.keyCode<41||(e.each(d,function(e,o){(o.groupName&&o.groupName.toLowerCase().indexOf(l.toLowerCase())>-1||o.name.toLowerCase().indexOf(l.toLowerCase())>-1||""+o.id==""+l)&&s.push(o)}),a.find("ul").html(t(n.call(this,s)[0])||i.searchNoData))},300),control:function(o){var t,n,i,a=o.keyCode,l=0;a!==d.down&&a!==d.up||(t=a===d.up?-1:1,l=-1===(n=(i=this.$el.find("[tabindex]")).index(e(document.activeElement)))?t+1?-1:0:n,(l+=t)===i.length&&(l=0),i.eq(l).focus(),o.preventDefault())},multiChoose:function(o,t){var n,i=this,a=i.config,l=i.$select,d=e(o.target),s=d.attr("data-value"),r=d.hasClass("dropdown-chose"),c=[];if(d.hasClass("dropdown-display"))return!1;if(r)d.removeClass("dropdown-chose"),i.selectAmount--;else{if(!(i.selectAmount<a.limitCount))return function(){var o=this,t=o.config,n=o.$el,i=n.find(".dropdown-maxItem-alert");clearTimeout(o.maxItemAlertTimer),0===i.length&&(i=e('<div class="dropdown-maxItem-alert">最多可选择'+t.limitCount+"个</div>")),n.append(i),o.maxItemAlertTimer=setTimeout(function(){n.find(".dropdown-maxItem-alert").remove()},1e3)}.call(i),!1;d.addClass("dropdown-chose"),i.selectAmount++}i.name=[],e.each(a.data,function(e,o){""+o.id==""+s&&(n=o,o.selected=!r),o.selected&&(c.push(o.name),i.name.push('<span class="dropdown-selected">'+o.name+'<i class="del" data-id="'+o.id+'"></i></span>'))}),l.find('option[value="'+s+'"]').prop("selected",!r),i.$choseList.find(".dropdown-selected").remove(),i.$choseList.prepend(i.name.join("")),i.$el.find(".dropdown-display").attr("title",c.join(",")),a.choice.call(i,o,n)},singleChoose:function(o){var t=this,n=t.config,i=t.$el,a=t.$select,l=e(o.target),d=l.attr("data-value"),s=l.hasClass("dropdown-chose");return!l.hasClass("dropdown-chose")&&!l.hasClass("dropdown-display")&&(t.name=[],i.removeClass("active").find("li").not(l).removeClass("dropdown-chose"),l.toggleClass("dropdown-chose"),e.each(n.data,function(e,o){o.selected=!1,""+o.id==""+d&&(o.selected=s?0:1,o.selected&&t.name.push('<span class="dropdown-selected">'+o.name+'<i class="del" data-id="'+o.id+'"></i></span>'))}),a.find('option[value="'+d+'"]').prop("selected",!0),t.name.push('<span class="placeholder">'+t.placeholder+"</span>"),t.$choseList.html(t.name.join("")),void n.choice.call(t,o))},del:function(o){var t=this,n=e(o.target),i=n.data("id");return e.each(t.name,function(e,o){if(-1!==o.indexOf('data-id="'+i+'"'))return t.name.splice(e,1),!1}),e.each(t.config.data,function(e,o){if(""+o.id==""+i)return o.selected=!1,!1}),t.selectAmount--,t.$el.find('[data-value="'+i+'"]').removeClass("dropdown-chose"),t.$el.find('[value="'+i+'"]').prop("selected",!1).removeAttr("selected"),n.closest(".dropdown-selected").remove(),!1},clearAll:function(o){return o&&o.preventDefault(),console.log(this),this.$choseList.find(".del").each(function(o,t){e(t).trigger("click")}),this.$el.find(".dropdown-display").removeAttr("title"),!1}};i.prototype={init:function(){var o=this,t=o.config,i=o.$el;o.$select.hide(),i.addClass(o.isSingleSelect?"dropdown-single":o.isLabelMode?"dropdown-multiple-label":"dropdown-multiple"),0===t.data.length&&(t.data=function(o){function t(o,t){var n=e(t);this.id=n.prop("value"),this.name=n.text(),this.disabled=n.prop("disabled"),this.selected=n.prop("selected")}var n=o,i=[];return e.each(n.children(),function(o,n){var a={},l={},d=e(n);"OPTGROUP"===n.nodeName?(l.groupId=d.data("groupId"),l.groupName=d.attr("label"),e.each(d.children(),e.proxy(t,a)),e.extend(a,l)):e.each(d,e.proxy(t,a)),i.push(a)}),i}(o.$select));var a=n.call(o,t.data);o.name=a[1],o.selectAmount=a[2],o.$select.html(a[0]),o.renderSelect(),o.changeStatus(t.disabled?"disabled":!!t.readonly&&"readonly"),o.config.init()},renderSelect:function(o,n){var i,a=this,l=a.$el,d=t(a.$select.prop("outerHTML"));o?l.find("ul")[n?"html":"append"](d):(i=function(){var e=this.isLabelMode,o=this.config.searchable?'<span class="dropdown-search">'+this.config.input+"</span>":"";return e?'<div class="dropdown-display-label"><div class="dropdown-chose-list">'+o+'</div></div><div class="dropdown-main">{{ul}}</div>':'<a href="javascript:;" class="dropdown-display" tabindex="0"><span class="dropdown-chose-list"></span><a href="javascript:;"  class="dropdown-clear-all" tabindex="0">×</a></a><div class="dropdown-main">'+o+"{{ul}}</div>"}.call(a).replace("{{ul}}","<ul>"+d+"</ul>"),l.append(i).find("ul").removeAttr("style class")),n&&(a.name=[],a.$el.find(".dropdown-selected").remove(),a.$select.val("")),a.$choseList=l.find(".dropdown-chose-list"),a.isLabelMode||a.$choseList.html(e('<span class="placeholder"></span>').text(a.placeholder)),a.$choseList.prepend(a.name?a.name.join(""):[])},bindEvent:function(){var o=this,t=o.$el,n=a?s:r;t.on(s,function(e){e.stopPropagation()}),t.on(s,".del",e.proxy(u.del,o)),o.isLabelMode?(t.on(s,".dropdown-display-label",function(){t.find("input").focus()}),o.config.searchable?t.on(r,"input",e.proxy(u.show,o)):t.on(s,e.proxy(u.show,o)),t.on(c,"input",function(e){8===e.keyCode&&""===this.value&&o.name.length&&t.find(".del").eq(-1).trigger("click")})):(t.on(n,".dropdown-display",e.proxy(u.show,o)),t.on(n,".dropdown-clear-all",e.proxy(u.clearAll,o))),t.on(p,"input",e.proxy(u.search,o)),t.on(p,function(t){t.keyCode===d.enter&&e.proxy(o.isSingleSelect?u.singleChoose:u.multiChoose,o,t)()}),t.on(c,e.proxy(u.control,o)),t.on(s,"li[tabindex]",e.proxy(o.isSingleSelect?u.singleChoose:u.multiChoose,o))},unbindEvent:function(){var e=this.$el,o=a?s:r;e.off(s),e.off(s,".del"),this.isLabelMode?(e.off(s,".dropdown-display-label"),e.off(r,"input"),e.off(c,"input")):(e.off(o,".dropdown-display"),e.off(o,".dropdown-clear-all")),e.off(p,"input"),e.off(p),e.off(c),e.off(s,"[tabindex]")},changeStatus:function(e){var o=this;"readonly"===e?o.unbindEvent():"disabled"===e?(o.$select.prop("disabled",!0),o.unbindEvent()):(o.$select.prop("disabled",!1),o.bindEvent())},update:function(e,o){var t=this,i=t.config,a=(t.$el,o||!1);if("[object Array]"===Object.prototype.toString.call(e)){i.data=a?e.slice(0):i.data.concat(e);var l=n.call(t,i.data);t.name=l[1],t.selectAmount=l[2],t.$select.html(l[0]),t.renderSelect(!0,a)}},destroy:function(){this.unbindEvent(),this.$el.children().not("select").remove(),this.$el.removeClass("dropdown-single dropdown-multiple-label dropdown-multiple"),this.$select.show()},choose:function(o,t){var n="[object Array]"===Object.prototype.toString.call(o)?o:[o],i=this,a=void 0===t||!!t;e.each(n,function(e,o){var n=i.$el.find('[data-value="'+o+'"]');n.hasClass("dropdown-chose")!==a&&n.trigger(s,t||!0)})},reset:function(){u.clearAll.call(this)}},e(document).on("click.dropdown",function(){e(".dropdown-single,.dropdown-multiple,.dropdown-multiple-label").removeClass("active")}),e.fn.dropdown=function(o){return this.each(function(t,n){e(n).data("dropdown",new i(e.extend(!0,{},l,o),n))}),this}}(jQuery);